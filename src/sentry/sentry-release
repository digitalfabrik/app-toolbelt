#!/usr/bin/env bash
#
# ARG_POSITIONAL_SINGLE([package-name],[package name under which to release],[])
# ARG_POSITIONAL_SINGLE([version-name],[name of the version to release],[])
# ARG_POSITIONAL_SINGLE([sourcemap-directory],[relative path to the directory where the sourcemap is],[])
# ARG_OPTIONAL_SINGLE([version-code],[o],[code of the version to release, this is only needed for react-native])
# ARG_HELP([This script creates a release in sentry. This file uses the configuration from ./.sentryclirc])
# ARGBASH_GO()
# needed because of Argbash --> m4_ignore([
### START OF CODE GENERATED BY Argbash v2.9.0 one line above ###
# Argbash is a bash code generator used to get arguments parsing right.
# Argbash is FREE SOFTWARE, see https://argbash.io for more info
# Generated online by https://argbash.io/generate




set -e
shopt -s nullglob

if ! command -v sentry-cli &> /dev/null
then
  curl -sL https://sentry.io/get-cli/ | bash
fi

package_name=$_arg_package_name
version_name=$_arg_version_name
version_code=$_arg_version_code
sourcemap_directory=$_arg_sourcemap_directory


if [ -z "$SENTRY_AUTH_TOKEN" ]
then
  echo "SENTRY_AUTH_TOKEN is not set"
  exit 1
fi

version="${package_name}@${version_name}"


if [ ! -z "$version_code" ]
then
      version="$version+${version_code}"
fi


sentry-cli releases new "$version" --finalize

sentry-cli releases files "$version" upload-sourcemaps "$sourcemap_directory" --dist "$version_code"

# ] <-- needed because of Argbash
